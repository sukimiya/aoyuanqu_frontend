<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>验证您的手机号码</title>
    <link href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href="https://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" type="text/css">
    <link href="https://cdn.bootcss.com/bootstrap-validator/0.5.3/css/bootstrapValidator.min.css" rel="stylesheet">
    <link href="css/unlock.css" rel="stylesheet" type="text/css">
    <link href="css/my.css" rel="stylesheet" type="text/css">

    <style type="text/css">
        .bar {
            margin: 20px;
            height: 40px;
            width: 300px;
        }

    </style>
    <!-- JS -->
    <script type="text/javascript" src="https://cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="https://cdn.bootcss.com/bootstrap-validator/0.5.3/js/bootstrapValidator.min.js"></script>
    <script src="http://res.wx.qq.com/open/js/jweixin-1.2.0.js"></script>
    <script src="https://cdn.bootcss.com/json2/20160511/json2.min.js"></script>

    <script type="text/javascript" src="js/my.js"></script>
    <script type="text/javascript">
        var redirectionLocation = "index.html";
        var validateCode_static = null;
        //----------------Reference from http://www.cnblogs.com/xcsn/archive/2013/04/22/3035240.html--------
        var InterValObj; //timer变量，控制时间
        var count = 60; //间隔函数，1秒执行
        var curCount; //当前剩余秒数
        $(document).ready(function() {
            var myapi = restapis;
            $("#dragVerfy").css("width", window.screen.width - 30 - 40 + "px");
            $("#dragVerfy").slideToUnlock({
                text: '滑动发送验证码',
                succText: '发送成功',
                successFunc: function() {
                    getVerfyCode();
                    $("#dragVerfy").remove();
                }
            });
            myweixin.onUser = function() {
                var user = myweixin.getUserInfo();
                if (user.hasOwnProperty("userid") && user.userid != "undefined")
                    myapi.request("getUserInfo", null, "oppen_id=" + myweixin.openid, function(result) {
                        if (result.mobile == 0) {

                        } else {
                            window.location.replace("index.html");
                        }
                    }, function() {
                        alert("网络错误，请稍后再试");
                    });
            }
            myweixin.initial();
            $('form').bootstrapValidator({
                feedbackIcons: {
                    valid: 'glyphicon glyphicon-ok',
                    invalid: 'glyphicon glyphicon-remove',
                    validating: 'glyphicon glyphicon-refresh'
                },
                disabled: true,
                excluded: ':disabled',
                fields: {
                    validateCode: {
                        validators: {
                            message: '验证失败',
                            notEmpty: {
                                message: '输入验证码',
                            }
                        }
                    },
                    inputmobile: {
                        validators: {
                            notEmpty: {
                                message: '请输入手机'
                            },
                            stringLength: {
                                min: 8,
                                max: 11,
                                message: '手机长度必须在8到11之间'
                            }
                        }
                    }
                }
            })
            $("#submitBtn").on("click", function() {

                var $this = $(this);
                $this.button('loading');
                if (validateCode_static != $("#InputValidateCode").val()) {
                    alert("请输入正确的验证码")
                }
                var fv_timestamp = Date.parse(new Date());
                var fv_mobileNumber = $("#inputmobile").val();
                var wx_openid = myweixin.requestOpenid();
                console.log("mobile=" + fv_mobileNumber + "  oppen_id=" + wx_openid);
                debugger;
                myapi.request("UserUpdate", null, "mobile=" + fv_mobileNumber + "&oppen_id=" + wx_openid, function(result) {
                    if (result) { //http://www.aoyuanqu.cn/lily/registbymobile.html?mobilephone
                        if (GetRequest().hasOwnProperty("mobilephone")) {
                            myapi.request("insertRecommand", null, "open_id=" + myweiin.openid + "&phone=" + GetRequest()["mobilephone"], function(result) {
                                console.log("recogenize persent:" + GetRequest()["mobilephone"]);
                            });
                        }
                        localStorage.removeItem("userid");
                        window.location = redirectionLocation;
                    } else if (result == 0) {
                        alert("用户注册失败");
                        $this.button('reset');
                    }
                }, function(e) {
                    alert("网络错误，请稍后再试");
                });
                setTimeout(function() {
                    $this.button('reset');
                    alert("请检查连接");
                }, 30000); //30秒超时


            });
            $("#inputmobile").on("change", function() {
                var fv_mobileNumber = $("#inputmobile").val();
                if ($("#inputmobile").val().length == 11) {
                    myapi.request("verfymobile", null, "mobile=" + fv_mobileNumber, function(result) {
                        if (result == 0) {

                        } else {
                            $("#changpwdform").data("bootstrapValidator").updateStatus("inputmobile", "NOT_VALIDATED", "手机号码已注册");
                        }
                    }, function(e) {
                        $("#changpwdform").data("bootstrapValidator").updateStatus("inputmobile", "NOT_VALIDATED", "手机号码验证错误,请稍后再试");
                    });
                } else {
                    $("#submitBtn").attr("disabled", "disabled");
                }
            });
            $("#InputValidateCode").on("change", function() {
                if (validateCode_static != null && $("InputValidateCode").val() == validateCode_static) {
                    $("#submitBtn").removeAttr("disabled");
                } else {
                    $("#submitBtn").attr("disabled", "disabled");
                }
            });
            var request = GetRequest();
            if (request["redict"]) {
                $.querySelector
                redirectionLocation = request["redict"];
            }
            $("#verfiyBtn").on("click", null, onVerfyBtnClickHandler1);

        }); //ready
        function onVerfyBtnClickHandler1() {
            $(".drag").removeClass("hide");
        }

        function onVerfyBtnClickHandler2() {
            $("#changpwdform").append('<div id="dragVerfy" class="hide bar drag">&nbsp;</div>');
            $("#dragVerfy").slideToUnlock({
                text: '滑动发送验证码',
                succText: '发送成功',
                successFunc: function() {
                    getVerfyCode();
                    $("#dragVerfy").remove();
                }
            });
            $(".drag").removeClass("hide");
        }

        function getVerfyCode() {
            var myapi = restapis;
            curCount = count;　　 //设置button效果，开始计时
            $("#verfiyBtn").attr("disabled", "on");
            var intid = setInterval(function() {
                curCount--;
                $("#verfiyBtn").text(curCount);
                //$("#verfiyBtn").attr("data-loading-text", " " + curCount);
                //document.title = "验证您的手机号码：" + curCount;
                if (curCount <= 0) {
                    $("#verfiyBtn").text("重新验证");
                    $("#verfiyBtn").removeAttr("disabled");
                    $("#verfiyBtn").off("click", null, onVerfyBtnClickHandler1);
                    $("#verfiyBtn").on("click", null, onVerfyBtnClickHandler2);
                    clearInterval(intid);
                }
            }, 1000);
            //

            var fv_mobileNumber = $("#inputmobile").val();
            debugger;
            myapi.request("checkMessage", null, "mobile=" + fv_mobileNumber, function(result) {
                if (result.valid) {
                    validateCode_static = result.validateCode;
                } else {
                    alert("发送验证码错误");
                    debugger;
                }
            }, function() {
                alert("网络错误，请稍后再试");
            });
        }

    </script>
</head>

<body>
    <div class="section my-topsection">

        <div class="container">
            <form id="changpwdform" class="my-form" role="form" data-toggle="validator">
                <div class="form-group">
                    <label for="InputMoblie">验证手机</label>
                    <input type="tel" name="inputmobile" class="form-control my-tel" id="inputmobile" required>
                </div>
                <div class="form-group" style="padding-bottom:80px;">
                    <label for="validateCodeGroup">验证码</label>
                    <div id="validateCodeGroup">
                        <div class="col-xs-6" style="padding-left:0px;">
                            <input type="number" name="validateCode" class="form-control col-xs-6" id="InputValidateCode" placeholder="------" maxlength="6" required>
                        </div>
                        <div class="col-xs-2">&nbsp;</div>
                        <button id="verfiyBtn" href="#" class="btn btn-success col-xs-4">验证</button>
                    </div>
                </div>
                <div id="dragVerfy" class="hide bar drag">&nbsp;</div>


            </form>

        </div>
    </div>
    <nav class="navbar navbar-default navbar-fixed-bottom" role="navigation" style="background-color:transparent;border:0px solid transparent;">
        <div class="container">
            <a id="submitBtn" class="btn btn-primary col-xs-12" data-loading-text="<i class='fa fa-circle-o-notch fa-spin'></i> " style="font-size:22px;">注册</a>
        </div>
    </nav>
    <script type="text/javascript" src="js/unlock.js"></script>
</body>

</html>
